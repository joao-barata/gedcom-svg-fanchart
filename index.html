<!DOCTYPE html>
<meta charset='utf-8'>
<script src='https://wzrd.in/standalone/parse-gedcom@latest'></script>
<script src='https://cdn.rawgit.com/jackmoore/autosize/master/dist/autosize.min.js'></script> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/snap.svg/0.4.1/snap.svg-min.js"></script> 
<style>
  * {
    box-sizing: border-box; 
  }
  html, body {
    font: 300 12px/1.3 arial;
    height: 100%;
    margin: 0;
  }

  .infos {
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  aside {
    position: absolute;
    display: flex;
    flex-flow: column;
    width: 12em;
    height: 100%;
    background-color: #fff;
    border-right: 1px solid #ddd;
    padding: 1em;
  }
  aside input,
  aside textarea {
    width: 100%;
    border: 1px solid #ddd;
    padding: .25em;
  }
  aside label{
    padding: .5em 0;
    font-size: .8em;
  }
  aside textarea {
    resize: none;
    overflow: hidden;
  }

  main {
    height: 100%;
    overflow: auto;
    margin-left: 12em;
  }

  .loaded .infos,
  aside,
  main {
    display: none;
  }
  .loaded main {
    display: block;
  }
  .loaded aside {
    display: flex;
  }
  @media print { 
    .loaded aside {
      display: none;
    }
    .loaded main {
      margin-left: 0;
    }
  }

  #title {
    text-align: center;
  }
  #chart {
    display: block;
    margin: auto;
  }


  .empty-slice path {
    fill: #f5f5f5;
  }
  .SEX_f path {
    fill: #eee;
  }
  .SEX_m path {
    fill: #ccc;
  }

</style>
<script type="text/javascript">//<![CDATA[
window.onload=function(){

var generations = 8,
    tree,
    textTemplates = [];

// file drop

window.addEventListener('dragover',function(e){
  e = e || event;
  e.preventDefault();
},false);
window.addEventListener('drop', function(e) {
  e = e || event;
  e.stopPropagation();
  e.preventDefault();
  var f = e.dataTransfer.files[0],
      reader = new FileReader();

  reader.onload = function(e) {
    tree = parseGedcom.parse(e.target.result);
    init();
  };
  reader.readAsText(f);
}, false);

// reload chart on settings changes
var fields = document.querySelectorAll('input, textarea');
[].forEach.call(fields, function(el) {
  el.addEventListener('change', init);
});
autosize(fields);

// helpers

String.prototype.trunc =
  function( n, useWordBoundary ){
    var isTooLong = this.length > n,
        s_ = isTooLong ? this.substr(0,n-1) : this;
    s_ = (useWordBoundary && isTooLong) ? s_.substr(0,s_.lastIndexOf(' ')) : s_;
    return  isTooLong ? s_ + '...' : s_;
  };

Math.radians = function(degrees) {
  return degrees * Math.PI / 180;
};

// init

function init(){

  generations = document.getElementById('generations').value;

  registerTextTemplates();

  var originID = document.getElementById('originID').value,
      origin = parseIndividual(getOrigin(originID)),
      ancestors = getAncestors(origin);

  //console.log(ancestors);

  setTitle(origin);
  drawChart(ancestors);

  document.body.classList.add('loaded');
  autosize.update(fields);
}

function registerTextTemplates () {
  var template = document.getElementById('textTemplate').value;
  textTemplates = template.split('\n').filter(function (el, i) {
    return el.trim().length > 0;
  });
}

function setTitle (origin) {
  var titleTemplate = document.getElementById('titleTemplate').value;
  document.getElementById('title').innerHTML = parseTextTemplate(titleTemplate, origin).join(' ');
}

function getOrigin (id) {
  return tree.filter(function (el) {
    return el.tag == 'INDI';
  })[id];
}

function getAncestors (origin) {
  var individuals = [origin];
  for (var gen = 0; gen <= generations; gen++)
  {
    var start = Math.floor(Math.pow(2, gen-1)),
        end = Math.pow(2, gen);

    for (var i = start; i < end; i++)
    {
      var parents = getParents(individuals[i]);
      if(parents.length == 0) {
        individuals.push({});
        individuals.push({});
      } else {
        individuals.push(parents[0]);
        individuals.push(parents[1]);
      }
    }
  }
  return individuals;
}
function getParents (indiv)
{
  if(indiv == undefined || indiv.tree == undefined) return [];

  // find family where indiv is child

  var indivFamilyID = indiv.tree.find(function (el) {
     return el.tag == 'FAMC';
  });
  if(indivFamilyID == undefined) return [];

  var indivFamily = tree.find(function (el) {
     return el.pointer == indivFamilyID.data;
  });
  if(indivFamily == undefined) return [];

  // get parents IDs of that family

  var parents = [];
  var parentA = indivFamily.tree.find(function (el) {
     return el.tag == 'HUSB';
  });
  var parentB = indivFamily.tree.find(function (el) {
     return el.tag == 'WIFE';
  });

  // get parents

  if(parentA !== undefined) {
    parents.push(tree.find(function (el) {
      return el.pointer == parentA.data;
    }));
  }
  if(parentB !== undefined) {
    parents.push(tree.find(function (el) {
      return el.pointer == parentB.data;
    }));
  }

  return parents.map(parseIndividual);
}

function parseIndividual (indiv) {
  indiv.classes = [];
  indiv.GENS = generations;
  // generic tags
  var tag,
      exclude = ['FAMC', 'FAMS', 'BIRT', 'DEAT', 'EVEN', 'SOUR', 'CHAN'];
  for (var i = 0; i < indiv.tree.length; i++) {
    tag = indiv.tree[i].tag;
    if (exclude.indexOf(tag) != -1)
      continue;
    indiv[tag] = indiv.tree[i].data;
    indiv.classes.push(tag+cssnamify(indiv.tree[i].data));
  }

  // name
  var names = parseName(indiv.tree[0].data);
  indiv.LAST = names.lastname;
  indiv.classes.push('LAST'+cssnamify(names.lastname));
  for (var i = 0; i < names.surnames.length; i++) {
    indiv.classes.push('SURS'+cssnamify(names.surnames[i]));
  }
  indiv.SURS = names.surnames.join(' ');

  // birth / death
  var birth = getEventInfos(indiv, 'BIRT');
  indiv.BDATE = birth.date;
  if(!indiv.BDATE || isNaN(indiv.BDATE)) indiv.BYEAR = '';
  else indiv.BYEAR = birth.date.getFullYear();

  indiv.BPLAC = birth.plac;
  if(indiv.BPLAC)
    indiv.BPLAC.split(',').forEach(function (el) {
      indiv.classes.push('PLAC'+cssnamify(el));
    });

  var death = getEventInfos(indiv, 'DEAT');
  indiv.DDATE = death.date;
  if(!indiv.DDATE || isNaN(indiv.DDATE)) indiv.DYEAR = '';
  else indiv.DYEAR = death.date.getFullYear();
  
  indiv.DPLAC = death.plac;
  if(indiv.DPLAC)
    indiv.DPLAC.split(',').forEach(function (el) {
      indiv.classes.push('PLAC'+cssnamify(el));
    });

  // texts contents
  indiv.texts = [];
  for (var i = 0; i < textTemplates.length; i++) {
    indiv.texts.push(parseTextTemplate(textTemplates[i], indiv));
  }

  return indiv; 
}
function getData (node, tag) {
  if(node.tree == undefined) return '';
  var result = node.tree.find(function (el) {
     return el.tag == tag; 
  });
  if(result == undefined) return '';
  return result.data;
}
function getEventInfos (indiv, tag) {
  var out = {date:null, plac:null};
  if(indiv.tree == undefined) return out;

  var event = indiv.tree.find(function (el) {
     return el.tag == tag; 
  });
  if(event == undefined) return out;

  out.date = new Date(getData(event, 'DATE')),
  out.plac = getData(event, 'PLAC');

  return out;
}
function parseName (name) {
  var nameregex = /\/(.*?)\//;
  var lastname = name.match(nameregex)[1];
  name = name.replace(nameregex, '');
  var surnames = name.trim().split(/[- ]+/);
  return {lastname: lastname || '', surnames: surnames};
}
function cssnamify(str) {
  str = str.trim().toLowerCase();
  str = str.normalize('NFD').replace(/[\u0300-\u036f]/g,""); // diactritics
  return '_' + str.replace(/[^a-z0-9]/g, function(s) {
    var c = s.charCodeAt(0);
    if (c == 32) return '-';
    return '';
  });
}

function parseTextTemplate (str, indiv)
{
  var keyreg = /([A-Z]{3,}(?:\.\.\.\d+)?)/g;
  str = str.split(keyreg).map( function(key) {
    if(!key.match(keyreg))
      return key;

    var param = key.split('...');
    key = param[0];
    param = Number(param[1]);

    if(!indiv.hasOwnProperty(key))
      return '';

    if(Array.isArray(indiv[key]))
      text = indiv[key].join(' ');
    else text = indiv[key];

    return ' ' + (param ? text.trunc(param, true) : text);
  });
  return str;
}

function maxTextsLength (indivs, start, end) {
  var max = 0, curr;
  for (var i=start; i<end; i++) {
    if(indivs[i] == undefined || indivs[i].texts == undefined)
      continue;
    indivs[i].texts.forEach( function(el, i) {
      curr = el.join(' ').length *3;
      if (curr > max) {
        max = curr;
      }
    });
  }
  return max;
}

function slicePathCoordinates (start, angle, r, t, reverse) {
  var arc1 = arcCoordinates(start, angle, r, reverse),
      arc2 = arcCoordinates(start+angle, -angle, r + t, reverse);
  return reverse ? { arc1:arc2, arc2:arc1 } : {arc1:arc1, arc2:arc2};
}
function arcCoordinates (start, angle, r, reverse) {
  if(reverse) {
    start = start+angle;
    angle *= -1;
  }
  return {
    r : r,
    a : {
      x : Math.cos(start) * r,
      y : Math.sin(start) * r
    },
    b : {
      x : Math.cos(start+angle) * r,
      y : Math.sin(start+angle) * r
    }
  };
}
function arcPath (start, angle, r, reverse) {
  var c = arcCoordinates(start, angle, r, reverse),
      arcdir = reverse ? '0,0' : '0,1';
  return " M"+c.a.x+","+c.a.y + " A"+r+","+r+" 0 "+arcdir+" "+c.b.x+","+c.b.y;
}

function drawChart (individuals) {

  var baseThickness = 35,
      border = 1;

  var radius = baseThickness,
      thickness,
      path, vline,
      text, textAttrs, textY;


  var rotation = Math.radians(Number(document.getElementById('rotation').value));

  var snap = Snap('#chart'),
      fan = snap.select('#fan');

  if(fan !== null)
    fan.remove();
  fan = snap.g().attr({id: 'fan'});

  var id = 0;
  for(var gen=1; gen<=generations; gen++)
  {
    var isHorizontal = gen < 4;
    var arcsNbr = Math.pow(2, gen);
    var arcAngle = 2*Math.PI / arcsNbr;

    thickness = isHorizontal ? baseThickness : maxTextsLength(individuals, id, id+arcsNbr);

    for(var j=0; j<arcsNbr; j++)
    {
      var startAngle = arcAngle * j + rotation;
      var middleAngle = startAngle + arcAngle * .5;
      var isTopHalf = middleAngle >= Math.PI && middleAngle <= Math.PI*2;
      var isLeftHalf = middleAngle >= Math.PI/2 && middleAngle < Math.PI * 1.5;
      var reverse = (isHorizontal && isTopHalf) || (!isHorizontal && isLeftHalf);

      // slice

      var coord = slicePathCoordinates(startAngle, arcAngle, radius, thickness);

      path  = " M"+coord.arc1.a.x+","+coord.arc1.a.y;
      path += " A"+coord.arc1.r+","+coord.arc1.r+" 0 0,1 "+coord.arc1.b.x+","+coord.arc1.b.y;
      path += " L"+coord.arc2.a.x+","+coord.arc2.a.y;
      path += " A"+coord.arc2.r+","+coord.arc2.r+" 0 0,0 "+coord.arc2.b.x+","+coord.arc2.b.y;
      path += " Z";

      var slice = fan.g();
      slice.addClass('slice GEN_'+gen);
      slice.path(path);

      id++;
      var indiv = individuals[id];
      if(indiv == undefined || indiv.tree == undefined) {
        slice.addClass('empty-slice');
        continue;
      }
      slice.addClass(indiv.classes.join(' '));

      // texts

      var lineCoord = slicePathCoordinates(startAngle+arcAngle*.5, 0, radius, thickness, reverse);
      vline = "M"+lineCoord.arc1.a.x+","+lineCoord.arc1.a.y+" "+lineCoord.arc2.a.x+","+lineCoord.arc2.a.y;

      textAttrs = {
        textpath: vline,
        fontSize: 7,
        textAnchor: 'middle'
      };

      if (isHorizontal) {
        // mid-distance horizontal arc
        textAttrs.textpath  = arcPath(startAngle, arcAngle, radius + thickness * .5, !reverse);
      }

      indiv.texts.forEach( function(text, index) {
        textAttrs.dy = index*8 + indiv.texts.length*-4 +8;
        slice.text(0,0, text )
             .attr(textAttrs)
             .textPath.attr({startOffset: '50%'});
      });
    }
    radius += thickness + border;
  }
  // size and center
  snap.attr({width: radius*2, height: radius*2});
  fan.transform('t'+radius+','+radius);
}

}//]]> 

</script>
<body>
<div class="infos">Drop a GEDCOM file</div>
<aside class="controls">
  <label>title<textarea id="titleTemplate">Ascendants fan chart of SURS LAST<br>GENS generations</textarea></label>
  <label>generations<input type="number" id="generations" min="1" max="10" value="6"></label>
  <label>origin ID<input type="number" id="originID" min="0" max="9999" value="0"></label>
  <label>content<textarea id="textTemplate">SURS...15 LAST
BYEAR - DYEAR
OCCU</textarea></label>
  <label>rotation<input type="number" id="rotation" min="0" max="360" step="45" value="90"></label>
</aside>
<main>
  <h3 id="title"></h3>
  <svg id="chart"></svg>
</main>
